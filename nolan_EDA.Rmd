---
title: "R Notebook"
output: github_document
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r setup}
library(tidyverse)
library(modelr)
library(runner)
source("cleaning.R")
set.seed(42)
```


```{r}
# all_ratings %>% head()
# all_ratings %>% summary()
```


```{r}
# all_ratings %>%
#   ggplot() +
#   geom_point(aes(x = harvest_year, y = total_cup_points))
```

```{r}
#If you do not have an ID per row, use the following code to create an ID
# all_ratings <- all_ratings %>% 
#   mutate(
#     id = row_number(),
#     total_cup_points = total_cup_points / 100,
#     owner = owner %>% as.factor(),
#     country_of_origin = country_of_origin %>% as.factor(),
#     company = company %>% as.factor(),
#     region = region %>% as.factor(),
#     producer = producer %>% as.factor(),
#     number_of_bags = number_of_bags %>% as.numeric(),
#     bag_weight = bag_weight %>% as.factor(),
#     harvest_year = harvest_year %>% as.numeric(),
#     variety = variety %>% as.factor(),
#     processing_method = processing_method %>% as.factor(),
#     category_one_defects = category_one_defects %>% as.numeric(),
#     quakers = quakers %>% as.numeric(),
#     color = color %>% as.factor(),
#     category_two_defects = category_two_defects %>% as.numeric(),
#     altitude_mean_meters = altitude_mean_meters %>% as.numeric()
#   )
# #Check IDs
# # head(all_ratings$id) 
# #Create training set
# train <- all_ratings %>% slice_sample(prop = .70)
# #Create test set
# test  <- all_ratings %>% anti_join(train, by = 'id')
```

```{r}
# fit_coffee_eda <-
#   glm(
#     formula = total_cup_points ~ 
#       # owner + 
#       country_of_origin +
#       # company + 
#       # region +
#       # producer +
#       number_of_bags +
#       # bag_weight +
#       harvest_year +
#       # variety +
#       processing_method +
#       category_one_defects +
#       quakers +
#       color +
#       category_two_defects +
#       altitude_mean_meters,
#     data = all_ratings,
#     family = "binomial"
#   )
# fit_tidy <- fit_coffee_eda %>% generics::tidy()
# rsquare(fit_coffee_eda, train)
# rsquare(fit_coffee_eda, test)
```

# Country-level
<!-- -------------------------------------------------- -->


```{r vis-usa}
df_usa %>%
  ggplot(aes(date)) +
  geom_point(aes(y = death, color = "Deaths")) +
  geom_point(aes(y = positive, color = "tests")) +
  scale_y_log10()
```

```{r usa-deaths-v-increase}
df_usa %>%
  ggplot(aes(death, deathIncrease)) +
  geom_point() +
  geom_smooth() +
  scale_x_log10() +
  scale_y_log10()
```

# State-level
<!-- -------------------------------------------------- -->

### Timeline: tests

```{r timeline-tests}
df_states_historical %>%
  # mutate(date = ymd(date)) %>%
  group_by(state_abbreviation) %>%
  mutate(max_positive = max(positive)) %>%
  ungroup() %>%
  filter(
    ## dense_rank(-max_positive) <= 10,
    ## state %in% c("CA", "NY", "WA", "MA", "HI")
    state_abbreviation %in% c("TX", "FL", "GA", "SC", "NC", "NY", "MA")
  ) %>%
  ggplot(aes(
    x = date,
    y = positive,
    color = fct_reorder2(state_abbreviation, date, positive)
    ## y = death,
    ## color = fct_reorder2(state, date, death)
  )) +
  geom_line() +
  ## scale_x_log10() +
  scale_y_log10(labels = scales::label_scientific()) +
  scale_color_discrete(name = "State") +
  theme_common()
```

### Timeline: Deaths

```{r timeline-tests}
df_states_historical %>%
  # mutate(date = ymd(date)) %>%state_abbreviation
  group_by(state_abbreviation) %>%
  mutate(max_positive = max(positive)) %>%
  ungroup() %>%
  filter(
    ## dense_rank(-max_positive) <= 10,
    state_abbreviation %in% c("CA", "NY", "WA", "MA")
  ) %>%
  ggplot(aes(
    x = date,
    y = death,
    color = fct_reorder2(state_abbreviation, date, death)
  )) +
  geom_line(size = 1) +
  scale_y_log10() +
  scale_color_discrete(name = "State") +
  theme_common()
```

### New vs Total plots

```{r vis-tests}
df_states_historical %>%
  group_by(state_abbreviation) %>%
  mutate(max_positive = max(positive)) %>%
  ungroup() %>%
  filter(
    positiveIncrease > 0,
    ## dense_rank(-max_positive) <= 10
    state_abbreviation %in% c("CA", "NY", "WA", "MA")
  ) %>%
  ggplot(aes(
    positive,
    positiveIncrease,
    color = state_abbreviation
  )) +
  geom_smooth(se = FALSE, size = 2) +
  ## geom_line() +
  ## geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme(legend.position = "bottom")
```

```{r vis-deaths}
df_states_historical %>%
  group_by(state_abbreviation) %>%
  mutate(max_positive = max(positive)) %>%
  ungroup() %>%
  filter(
    positiveIncrease > 0,
    ## dense_rank(-max_positive) <= 10
    state_abbreviation %in% c("CA", "NY", "WA", "MA")
  ) %>%
  ggplot(aes(
    death,
    deathIncrease,
    color = state_abbreviation
  )) +
  geom_smooth(se = FALSE, size = 2) +
  ## geom_line() +
  ## geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme(legend.position = "bottom")
```

```{r vis-tests}
df_states_historical %>%
  group_by(state_abbreviation) %>%
  mutate(max_test = max(totalTestResults)) %>%
  ungroup() %>%
  filter(
    totalTestResults > 0,
    ## dense_rank(-max_test) <= 5
    str_detect(state_abbreviation, "HI")
  ) %>%
  ggplot(aes(
    totalTestResults,
    totalTestResultsIncrease,
    color = state_abbreviation
  )) +
  geom_smooth(se = FALSE, size = 2) +
  geom_line() +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme_common()+
  theme(legend.position = "bottom")
```


```{r vis-normalized}
df_states_historical %>%
  group_by(state_abbreviation) %>%
  mutate(max_positive = max(positive)) %>%
  ungroup() %>%
  filter(
    positiveIncrease > 0,
    dense_rank(-max_positive) <= 8
  ) %>%
  ggplot(aes(
    positive / totalTestResults,
    positiveIncrease / totalTestResults,
    color = state_abbreviation
  )) +
  geom_smooth(se = FALSE, size = 2) +
  geom_line() +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme(legend.position = "bottom")
```

```{r}
df_states_historical %>%
  filter(state == "New York") %>%
  mutate(
    positivity_rate = (positiveIncrease/totalTestResultsIncrease),
    projected_tests = population * positivity_rate
  ) %>%
  ggplot() +
  geom_point(aes(x=date, y=positiveIncrease, color="positive tests increase"))
  # geom_point(aes(x=date, y=projected_tests, color="population * positivity rate"))
```


```{r}
df_states_historical %>%
  filter(state == "New York") %>%
  mutate(
    positivity_rate = (positiveIncrease/totalTestResultsIncrease),
    projected_tests = population * positivity_rate
  ) %>%
  ggplot() +
  geom_point(aes(x=date, y=positiveIncrease, color="positiveIncrease")) +
  geom_point(aes(x=date, y=projected_tests, color="population * positivity rate")) +
  geom_line(aes(x=date, y=population, color="NY Total Population"))
```

```{r}
df_states_historical %>%
  filter(state == "New York") %>%
  mutate(
    positivity_rate = (positiveIncrease/totalTestResultsIncrease),
    projected_tests = population * positivity_rate
  ) %>%
  ggplot() +
  geom_point(aes(x=date, y=positivity_rate, color="positivity rate"))
```

```{r}
df_states_racial_comb %>%
  filter(state == "California") %>%
  left_join(df_states_historical) %>%
  ggplot() +
  geom_line(aes(x=date, y=tests/positive, color=race))
```

```{r}
df_states_racial_comb %>%
  filter(state == "California") %>%
  left_join(df_states_historical) %>%
  ggplot() +
  geom_line(aes(x=date, y=tests_per_100k, color=race))
```


```{r}
foo <- df_states_racial_comb %>%
  filter(!is.na(date)) %>%
  arrange(date) %>%
  group_by(race, state) %>%
  mutate(
    rolling7dayavg_tests = mean_run(x = tests, k = 8, idx = date)
  ) %>%
  relocate(
    rolling7dayavg_tests,
    .after = tests
  ) %>%
  filter(state=="California",race=="White")

foo %>%
  ggplot() +
  geom_point(aes(x=date,y=tests,color="tests")) +
  geom_point(aes(x=date,y=rolling7dayavg_tests, color="rolling 7 day"))

```

```{r}
tests_model <- glm(
    formula = tests_per_100k ~ date + race + race_estimate,
    data = df_states_racial_comb %>%
      mutate(
        race = race %>% as.factor(),
        race = fct_relevel(race, "White"),
        tests_per_100k = tests_per_100k/max(tests_per_100k, na.rm = TRUE),
        race_estimate = race_estimate/max(race_estimate, na.rm = TRUE)
      ) %>%
      filter(
        !is.na(tests_per_100k),
      ),
    family = "binomial"
  )
tests_model %>% generics::tidy()
```




```{r}
df_states_racial_comb %>%
  filter(!is.na(tests)) %>%
  filter(tests != 0) %>%
  filter(race != "Other") %>%
  filter(race_estimate > 10000) %>%
  group_by(date,state) %>%
  summarize(
    tot_tests = sum(tests, na.rm = TRUE)
  ) %>%
  ggplot() +
  geom_line(aes(x=date, y=tot_tests)) +
  facet_wrap(~ state, scales = "free_y")
  # scale_y_log10()
```

```{r}
df_states_racial_comb %>%
  filter(!is.na(tests_per_100k)) %>%
  filter(tests_per_100k != 0) %>%
  filter(race_estimate > 10000) %>%
  group_by(race, state) %>%
  arrange(date) %>%
  mutate(
    delta_tests_per_100k = tests_per_100k - lag(tests_per_100k)
  ) %>%
  filter(race != "Other") %>%
  # filter(state == "Rhode Island") %>%
  filter(delta_tests_per_100k > 0) %>%
  filter(state == "Illinois") %>%
  ggplot() +
  geom_line(aes(x=date, y=delta_tests_per_100k, color=race)) +
  facet_wrap(~ state, scales = "free_y")
```



```{r}
df_states_racial_comb %>%
  filter(!is.na(tests_per_100k)) %>%
  filter(tests_per_100k != 0) %>%
  filter(race != "Other") %>%
  filter(race_estimate > 10000) %>%
  ggplot() +
  geom_boxplot(aes(x=race, y=tests_per_100k, color=race)) +
  facet_wrap(~ state, scales = "free_y")
```


```{r}
df_states_racial_comb %>%
  filter(!is.na(tests)) %>% 
  filter(tests > 100) %>%
  group_by(date, race) %>% 
  summarise(
    # deaths_per_tests = sum(deaths)/sum(tests),
    # hosp_per_tests = sum(hosp, na.rm = "TRUE")/sum(tests,  na.rm = "TRUE"),
    # deaths_per_hosp = sum(deaths,  na.rm = "TRUE")/sum(hosp,  na.rm = "TRUE"),
    tests = sum(tests),
    race_estimate = sum(race_estimate),
    .groups = "keep"
  ) %>% 
  mutate(
    tests_per_100k = tests/race_estimate
  ) %>%
   # filter(deaths_per_tests < .25) %>% 
ggplot(aes(x = date, y = tests_per_100k, color = race)) +
  geom_point(aes(shape = race), size = 1) +
  geom_line()
```


```{r}
df_states_racial_comb %>%
  group_by(date, state) %>%
  mutate(
    sum_tests = sum(tests),
    fraction_tests = tests/sum_tests
  ) %>%
  filter(!is.na(sum_tests)) %>%
  ggplot() +
  geom_line(aes(x=date,y=fraction_tests,color=race)) +
  facet_wrap(~ state) +
  theme_common() +
  theme(
    aspect.ratio = 9 / 16
  )
```

```{r}
# df_states_racial_comb %>%
#   filter(
#     # race_estimate > 5000, 
#     # race != "Other",
#     # tests_per_100k > 1000
#   ) %>%
#   group_by(race, state) %>%
#   arrange(date) %>%
#   mutate(
#     delta_tests_per_100k = tests_per_100k - lag(tests_per_100k)
#   ) %>%
#   ungroup() %>%
#   group_by(date, state) %>%
#   mutate(
#     mean_dtests_per_100k = mean(delta_tests_per_100k, na.rm = TRUE),
#     diff_per100k_frommean = tests_per_100k - mean_dtests_per_100k
#   ) %>%
#   filter(!is.na(diff_per100k_frommean)) %>%
#   # group_modify(
#   #   #add_row(date = .$date, state = .$state, race = "Mean", diff_per100k_frommean = 1)
#   #   ~ {.x %>% add_row(race = "Mean", diff_per100k_frommean = 1) }
#   # ) %>%
#   ggplot() +
#   geom_line(aes(x=date,y=diff_per100k_frommean,color=race)) +
#   facet_wrap(~ state) +
#   theme_common() +
#   theme(
#     aspect.ratio = 9 / 16
#   )
```


```{r}

df_states_racial_comb %>%
  filter(!is.na(tests)) %>%
  filter(race_estimate > 5000) %>%
  filter(race != "Other") %>%
  filter(state != "Utah" & state != "Rhode Island") %>%
  group_by(date, state) %>%
  mutate(
    tot_tests = sum(tests, na.rm = TRUE),
    tot_tested_pop = sum(race_estimate, na.rm = TRUE)
  ) %>%
  group_by(date, state, race) %>%
  mutate(
    test_frac = tests/tot_tests,
    pop_frac = race_estimate/tot_tested_pop,
    tests_to_pop_ratio = test_frac / pop_frac
  ) %>%
  filter(tests_to_pop_ratio != 0) %>%
  ungroup() %>%
  ggplot() +
  geom_line(aes(x = date, y = tests_to_pop_ratio, color = race)) +
  facet_wrap(~ state)
```


```{r}
df_states_racial_comb %>%
  filter(!is.na(tests)) %>%
  filter(tests != 0) %>%
  group_by(race, state) %>%
  arrange(date) %>%
  mutate(
    delta_tests_instant = tests - lag(tests),
    delta_tests_avg = mean_run(x = tests, k = 8, idx = date), #THIS IS WRONG!!!
    delta_tests = delta_tests_avg
  ) %>%
  filter(delta_tests > 0) %>%
  filter(race_estimate > 5000) %>%
  filter(race != "Other") %>%
  filter(state != "Utah" & state != "Rhode Island") %>%
  group_by(date, state) %>%
  mutate(
    tot_dtests = sum(delta_tests, na.rm = TRUE),
    tot_tested_pop = sum(race_estimate, na.rm = TRUE)
  ) %>%
  group_by(date, state, race) %>%
  mutate(
    dtest_frac = delta_tests/tot_dtests,
    pop_frac = race_estimate/tot_tested_pop,
    tests_to_pop_ratio = dtest_frac / pop_frac
  ) %>%
  filter(tests_to_pop_ratio != 0) %>%
  ungroup() %>%
  ggplot() +
  geom_line(aes(x = date, y = tests_to_pop_ratio, color = race)) +
  facet_wrap(~ state, scales = "free_y")


```


```{r}
df_us_racial_comb <- df_states_racial_comb %>% group_by(date,race) %>%
  filter(!is.na(tests)) %>%
  filter(tests > 0) %>%
  summarize(
    state = "Sum of states that report tests",
    tests = sum(tests, na.rm = TRUE),
    population = sum(population, na.rm = TRUE),
    race_estimate = sum(race_estimate, na.rm = TRUE)
  )
foo <- df_states_racial_comb %>%
  merge(df_us_racial_comb, all = TRUE) %>%
  filter(!is.na(tests)) %>%
  filter(tests > 0) %>%
  group_by(race, state) %>%
  arrange(date) %>%
  mutate(
    delta_tests_inst = tests - lag(tests)
  ) %>%
  ungroup() %>%
  group_by(state, date) %>%
  # filter(all(delta_tests_inst >= 0)) %>%
  ungroup() %>%
  group_by(race, state) %>%
  mutate(
    delta_tests_avg = mean_run(x = delta_tests_inst, k = 15, idx = date)
  ) %>%
  # filter(delta_tests_inst > 0, delta_tests_avg > 0) %>%
  filter(race_estimate > 5000) %>%
  filter(race != "Other" & race != "Multiracial" & race != "Unknown") %>%
  filter(state != "Utah") %>%
  filter(state != "Rhode Island") %>%
  ungroup() %>%
  group_by(date, state) %>%
  mutate(
    tot_dtests_avg = sum(delta_tests_avg, na.rm = TRUE),
    tot_dtests_inst = sum(delta_tests_inst, na.rm = TRUE),
    tot_tested_pop = sum(race_estimate, na.rm = TRUE)
  ) %>%
  # filter(tot_dtests_avg > 1000 & tot_dtests_inst > 1000) %>%
  # filter(tot_dtests_avg != tot_dtests_inst) %>%
  ungroup() %>%
  group_by(state) %>%
  filter(tot_dtests_inst > 0) %>%
  ungroup() %>%
  group_by(state, race) %>%
  filter(abs(tot_dtests_inst) / mean(tot_dtests_inst, na.rm = TRUE) < 2) %>%
  ungroup() %>%
  group_by(date, state, race) %>%
  mutate(
    dtest_frac_avg = delta_tests_avg/tot_dtests_avg,
    dtest_frac_inst = delta_tests_inst/tot_dtests_inst,
    pop_frac = race_estimate/tot_tested_pop,
    tests_to_pop_ratio_avg = dtest_frac_avg / pop_frac,
    tests_to_pop_ratio_inst = dtest_frac_inst / pop_frac
  ) %>%
  # filter(tests_to_pop_ratio_avg != 0, tests_to_pop_ratio_inst != 0) %>%
  ungroup() %>%
  group_by(state,race) %>%
  filter((abs(tests_to_pop_ratio_inst)/mean(tests_to_pop_ratio_inst, na.rm = TRUE)) < 5) %>%
  ungroup() %>%
  group_by(date, state) %>%
  filter(all(tests_to_pop_ratio_inst > 0)) %>%
  ungroup() %>%
  group_by(race, state) %>%
  mutate(
    tests_to_pop_ratio_avg2 = mean_run(x = tests_to_pop_ratio_inst, k = 30, idx = date)
  ) %>%
  pivot_longer(
    cols = c(tests_to_pop_ratio_avg2, tests_to_pop_ratio_inst),
    names_to = "avg_or_inst",
    values_to = "tests_to_pop_ratio"
  ) %>%
  mutate(
    avg_or_inst = ifelse(avg_or_inst == "tests_to_pop_ratio_avg2", "30 Day Average", "Instantaneous")
  ) %>%
  filter(state == "Sum of states that report tests")
foo %>%
  ggplot() +
  geom_hline(color="black", alpha=0.5, yintercept=1)+
  geom_line(aes(x = date, y = tests_to_pop_ratio, color = race, alpha = avg_or_inst, size = avg_or_inst)) +
  scale_alpha_manual(values = c("Instantaneous" = 0.25, "30 Day Average" = 1)) +
  scale_size_manual(values = c("Instantaneous" = 0.5, "30 Day Average" = 1)) +
  facet_wrap(~ state) +
  coord_cartesian(ylim = c(0,5)) +
  theme_common() +
  theme(
    aspect.ratio = 9 / 16,
    # legend.title = element_text(size = 12, face = "bold"),
    # axis.title.x = element_text(margin = margin(4, 4, 4, 4), size = 12, face = "bold"),
    # axis.title.y = element_text(margin = margin(4, 4, 4, 4), size = 12, angle = 90, face = "bold"),
    # legend.box.just = "right",
    # plot.background = element_rect(color="blue")
    #legend.margin = margin(0,0,0,0)
    # legend.background = element_rect(size =  color = "blue")
  ) +
  labs(
    x = "Date",
    y = "Race Test % to Race Population %",
    alpha = str_wrap("Average or Instantaneous", width = 20),
    size = str_wrap("Average or Instantaneous", width = 20),
    color = "Race"
  )


```

```{r}
df_states_racial_comb %>%
  filter(!is.na(tests)) %>%
  filter(tests > 0) %>%
  group_by(race, state) %>%
  arrange(date) %>%
  mutate(
    delta_tests_inst = tests - lag(tests)
  ) %>%
  ungroup() %>%
  group_by(state, date) %>%
  # filter(all(delta_tests_inst >= 0)) %>%
  ungroup() %>%
  group_by(race, state) %>%
  mutate(
    delta_tests_avg = mean_run(x = delta_tests_inst, k = 15, idx = date)
  ) %>%
  # filter(delta_tests_inst > 0, delta_tests_avg > 0) %>%
  filter(race_estimate > 5000) %>%
  filter(race != "Other" & race != "Multiracial" & race != "Unknown") %>%
  # filter(state != "Utah") %>%
  # filter(state != "Rhode Island") %>%
  ungroup() %>%
  group_by(date, state) %>%
  mutate(
    tot_dtests_avg = sum(delta_tests_avg, na.rm = TRUE),
    tot_dtests_inst = sum(delta_tests_inst, na.rm = TRUE),
    tot_tested_pop = sum(race_estimate, na.rm = TRUE)
  ) %>%
  # filter(tot_dtests_avg > 1000 & tot_dtests_inst > 1000) %>%
  # filter(tot_dtests_avg != tot_dtests_inst) %>%
  ungroup() %>%
  group_by(state) %>%
  filter(tot_dtests_inst > 0) %>%
  ungroup() %>%
  group_by(state, race) %>%
  filter(abs(tot_dtests_inst) / mean(tot_dtests_inst, na.rm = TRUE) < 2) %>%
  ungroup() %>%
  group_by(date, state, race) %>%
  mutate(
    dtest_frac_avg = delta_tests_avg/tot_dtests_avg,
    dtest_frac_inst = delta_tests_inst/tot_dtests_inst,
    pop_frac = race_estimate/tot_tested_pop,
    tests_to_pop_ratio_avg = dtest_frac_avg / pop_frac,
    tests_to_pop_ratio_inst = dtest_frac_inst / pop_frac
  ) %>%
  # filter(tests_to_pop_ratio_avg != 0, tests_to_pop_ratio_inst != 0) %>%
  ungroup() %>%
  group_by(state,race) %>%
  filter((abs(tests_to_pop_ratio_inst)/mean(tests_to_pop_ratio_inst, na.rm = TRUE)) < 5) %>%
  ungroup() %>%
  group_by(date, state) %>%
  filter(all(tests_to_pop_ratio_inst > 0)) %>%
  
  # pivot_longer(
  #   cols = c(tests_to_pop_ratio_avg, tests_to_pop_ratio_inst),
  #   names_to = "avg_or_inst",
  #   values_to = "tests_to_pop_ratio"
  # ) %>%
  # mutate(
  #   avg_or_inst = ifelse(avg_or_inst == "tests_to_pop_ratio_avg", "15 Day Average", "Instantaneous")
  # ) %>%
  ggplot() +
  geom_line(aes(x = date, y = tests_to_pop_ratio_inst, color = race), alpha = 0.2, size = 0.5) +
  # geom_point(aes(x = date, y = delta_tests_inst, color = race)) +
  geom_smooth(
    aes(x = date, y = tests_to_pop_ratio_inst, color = race),
    # method = "loess",
    span = 0.7,
    level = 0.8
  )+
  facet_wrap(~ state, scales="free_y") +
  # coord_cartesian(ylim = c(-5,10)) +
  theme_common() +
  theme(
    aspect.ratio = 9 / 16,
    # legend.title = element_text(size = 12, face = "bold"),
    # axis.title.x = element_text(margin = margin(4, 4, 4, 4), size = 12, face = "bold"),
    # axis.title.y = element_text(margin = margin(4, 4, 4, 4), size = 12, angle = 90, face = "bold"),
    # legend.box.just = "right",
    # plot.background = element_rect(color="blue")
    #legend.margin = margin(0,0,0,0)
    # legend.background = element_rect(size =  color = "blue")
  ) +
  labs(
    x = "Date",
    y = "Race Test Percent to Race Population Percent",
    color = "Race"
  )


```



```{r}
df_us_racial_comb <- df_states_racial_comb %>% group_by(date,race) %>%
  filter(!is.na(cases)) %>%
  filter(cases > 0) %>%
  summarize(
    state = "Sum of states that report cases",
    cases = sum(cases, na.rm = TRUE),
    population = sum(population, na.rm = TRUE),
    race_estimate = sum(race_estimate, na.rm = TRUE)
  )
foo <- df_states_racial_comb %>%
  merge(df_us_racial_comb, all = TRUE) %>%
  filter(!is.na(cases)) %>%
  filter(cases > 0) %>%
  group_by(race, state) %>%
  arrange(date) %>%
  mutate(
    delta_cases_inst = cases - lag(cases)
  ) %>%
  ungroup() %>%
  group_by(state, date) %>%
  # filter(all(delta_cases_inst >= 0)) %>%
  ungroup() %>%
  group_by(race, state) %>%
  mutate(
    delta_cases_avg = mean_run(x = delta_cases_inst, k = 15, idx = date)
  ) %>%
  # filter(delta_cases_inst > 0, delta_cases_avg > 0) %>%
  filter(race_estimate > 5000) %>%
  filter(race != "Other" & race != "Multiracial" & race != "Unknown") %>%
  filter(state != "Utah") %>%
  filter(state != "Rhode Island") %>%
  ungroup() %>%
  group_by(date, state) %>%
  mutate(
    tot_dcases_avg = sum(delta_cases_avg, na.rm = TRUE),
    tot_dcases_inst = sum(delta_cases_inst, na.rm = TRUE),
    tot_tested_pop = sum(race_estimate, na.rm = TRUE)
  ) %>%
  # filter(tot_dcases_avg > 1000 & tot_dcases_inst > 1000) %>%
  # filter(tot_dcases_avg != tot_dcases_inst) %>%
  ungroup() %>%
  group_by(state) %>%
  filter(tot_dcases_inst > 0) %>%
  ungroup() %>%
  group_by(state, race) %>%
  filter(abs(tot_dcases_inst) / mean(tot_dcases_inst, na.rm = TRUE) < 2) %>%
  ungroup() %>%
  group_by(date, state, race) %>%
  mutate(
    dtest_frac_avg = delta_cases_avg/tot_dcases_avg,
    dtest_frac_inst = delta_cases_inst/tot_dcases_inst,
    pop_frac = race_estimate/tot_tested_pop,
    cases_to_pop_ratio_avg = dtest_frac_avg / pop_frac,
    cases_to_pop_ratio_inst = dtest_frac_inst / pop_frac
  ) %>%
  # filter(cases_to_pop_ratio_avg != 0, cases_to_pop_ratio_inst != 0) %>%
  ungroup() %>%
  group_by(state,race) %>%
  filter((abs(cases_to_pop_ratio_inst)/mean(cases_to_pop_ratio_inst, na.rm = TRUE)) < 5) %>%
  ungroup() %>%
  group_by(date, state) %>%
  filter(all(cases_to_pop_ratio_inst > 0)) %>%
  ungroup() %>%
  group_by(race, state) %>%
  mutate(
    cases_to_pop_ratio_avg2 = mean_run(x = cases_to_pop_ratio_inst, k = 30, idx = date)
  ) %>%
  pivot_longer(
    cols = c(cases_to_pop_ratio_avg2, cases_to_pop_ratio_inst),
    names_to = "avg_or_inst",
    values_to = "cases_to_pop_ratio"
  ) %>%
  mutate(
    avg_or_inst = ifelse(avg_or_inst == "cases_to_pop_ratio_avg2", "30 Day Average", "Instantaneous")
  ) %>%
  filter(state == "Sum of states that report cases")
foo %>%
  ggplot() +
  geom_hline(color="black", alpha=0.5, yintercept=1)+
  geom_line(aes(x = date, y = cases_to_pop_ratio, color = race, alpha = avg_or_inst, size = avg_or_inst)) +
  scale_alpha_manual(values = c("Instantaneous" = 0.25, "30 Day Average" = 1)) +
  scale_size_manual(values = c("Instantaneous" = 0.5, "30 Day Average" = 1)) +
  facet_wrap(~ state) +
  coord_cartesian(ylim = c(0,5)) +
  theme_common() +
  theme(
    aspect.ratio = 9 / 16,
    # legend.title = element_text(size = 12, face = "bold"),
    # axis.title.x = element_text(margin = margin(4, 4, 4, 4), size = 12, face = "bold"),
    # axis.title.y = element_text(margin = margin(4, 4, 4, 4), size = 12, angle = 90, face = "bold"),
    # legend.box.just = "right",
    # plot.background = element_rect(color="blue")
    #legend.margin = margin(0,0,0,0)
    # legend.background = element_rect(size =  color = "blue")
  ) +
  labs(
    x = "Date",
    y = "Race Case % to Race Population %",
    alpha = str_wrap("Average or Instantaneous", width = 20),
    size = str_wrap("Average or Instantaneous", width = 20),
    color = "Race"
  ) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")


```


```{r}
df_us_racial_comb <- df_states_racial_comb %>% group_by(date,race) %>%
  filter(!is.na(deaths)) %>%
  filter(deaths > 0) %>%
  summarize(
    state = "Sum of states that report deaths",
    deaths = sum(deaths, na.rm = TRUE),
    population = sum(population, na.rm = TRUE),
    race_estimate = sum(race_estimate, na.rm = TRUE)
  )
foo <- df_states_racial_comb %>%
  merge(df_us_racial_comb, all = TRUE) %>%
  filter(!is.na(deaths)) %>%
  filter(deaths > 0) %>%
  group_by(race, state) %>%
  arrange(date) %>%
  mutate(
    delta_deaths_inst = deaths - lag(deaths)
  ) %>%
  ungroup() %>%
  group_by(state, date) %>%
  # filter(all(delta_deaths_inst >= 0)) %>%
  ungroup() %>%
  group_by(race, state) %>%
  mutate(
    delta_deaths_avg = mean_run(x = delta_deaths_inst, k = 15, idx = date)
  ) %>%
  # filter(delta_deaths_inst > 0, delta_deaths_avg > 0) %>%
  filter(race_estimate > 5000) %>%
  filter(race != "Other" & race != "Multiracial" & race != "Unknown") %>%
  filter(state != "Utah") %>%
  filter(state != "Rhode Island") %>%
  ungroup() %>%
  group_by(date, state) %>%
  mutate(
    tot_ddeaths_avg = sum(delta_deaths_avg, na.rm = TRUE),
    tot_ddeaths_inst = sum(delta_deaths_inst, na.rm = TRUE),
    tot_tested_pop = sum(race_estimate, na.rm = TRUE)
  ) %>%
  # filter(tot_ddeaths_avg > 1000 & tot_ddeaths_inst > 1000) %>%
  # filter(tot_ddeaths_avg != tot_ddeaths_inst) %>%
  ungroup() %>%
  group_by(state) %>%
  filter(tot_ddeaths_inst > 0) %>%
  ungroup() %>%
  group_by(state, race) %>%
  filter(abs(tot_ddeaths_inst) / mean(tot_ddeaths_inst, na.rm = TRUE) < 2) %>%
  ungroup() %>%
  group_by(date, state, race) %>%
  mutate(
    dtest_frac_avg = delta_deaths_avg/tot_ddeaths_avg,
    dtest_frac_inst = delta_deaths_inst/tot_ddeaths_inst,
    pop_frac = race_estimate/tot_tested_pop,
    deaths_to_pop_ratio_avg = dtest_frac_avg / pop_frac,
    deaths_to_pop_ratio_inst = dtest_frac_inst / pop_frac
  ) %>%
  # filter(deaths_to_pop_ratio_avg != 0, deaths_to_pop_ratio_inst != 0) %>%
  ungroup() %>%
  group_by(state,race) %>%
  filter((abs(deaths_to_pop_ratio_inst)/mean(deaths_to_pop_ratio_inst, na.rm = TRUE)) < 5) %>%
  ungroup() %>%
  group_by(date, state) %>%
  filter(all(deaths_to_pop_ratio_inst > 0)) %>%
  ungroup() %>%
  group_by(race, state) %>%
  mutate(
    deaths_to_pop_ratio_avg2 = mean_run(x = deaths_to_pop_ratio_inst, k = 30, idx = date)
  ) %>%
  pivot_longer(
    cols = c(deaths_to_pop_ratio_avg2, deaths_to_pop_ratio_inst),
    names_to = "avg_or_inst",
    values_to = "deaths_to_pop_ratio"
  ) %>%
  mutate(
    avg_or_inst = ifelse(avg_or_inst == "deaths_to_pop_ratio_avg2", "30 Day Average", "Instantaneous")
  ) %>%
  filter(state == "Sum of states that report deaths")
foo %>%
  ggplot() +
  geom_hline(color="black", alpha=0.5, yintercept=1)+
  geom_line(aes(x = date, y = deaths_to_pop_ratio, color = race, alpha = avg_or_inst, size = avg_or_inst)) +
  scale_alpha_manual(values = c("Instantaneous" = 0.25, "30 Day Average" = 1)) +
  scale_size_manual(values = c("Instantaneous" = 0.5, "30 Day Average" = 1)) +
  facet_wrap(~ state) +
  coord_cartesian(ylim = c(0,5)) +
  theme_common() +
  theme(
    aspect.ratio = 9 / 16,
    # legend.title = element_text(size = 12, face = "bold"),
    # axis.title.x = element_text(margin = margin(4, 4, 4, 4), size = 12, face = "bold"),
    # axis.title.y = element_text(margin = margin(4, 4, 4, 4), size = 12, angle = 90, face = "bold"),
    # legend.box.just = "right",
    # plot.background = element_rect(color="blue")
    #legend.margin = margin(0,0,0,0)
    # legend.background = element_rect(size =  color = "blue")
  ) +
  labs(
    x = "Date",
    y = "Race Death % to Race Population %",
    alpha = str_wrap("Average or Instantaneous", width = 20),
    size = str_wrap("Average or Instantaneous", width = 20),
    color = "Race"
  ) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")


```
