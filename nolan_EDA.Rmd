---
title: "R Notebook"
output: github_document
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r setup}
library(tidyverse)
library(modelr)
source("cleaning.R")
set.seed(42)
```


```{r}
# all_ratings %>% head()
# all_ratings %>% summary()
```


```{r}
# all_ratings %>%
#   ggplot() +
#   geom_point(aes(x = harvest_year, y = total_cup_points))
```

```{r}
#If you do not have an ID per row, use the following code to create an ID
# all_ratings <- all_ratings %>% 
#   mutate(
#     id = row_number(),
#     total_cup_points = total_cup_points / 100,
#     owner = owner %>% as.factor(),
#     country_of_origin = country_of_origin %>% as.factor(),
#     company = company %>% as.factor(),
#     region = region %>% as.factor(),
#     producer = producer %>% as.factor(),
#     number_of_bags = number_of_bags %>% as.numeric(),
#     bag_weight = bag_weight %>% as.factor(),
#     harvest_year = harvest_year %>% as.numeric(),
#     variety = variety %>% as.factor(),
#     processing_method = processing_method %>% as.factor(),
#     category_one_defects = category_one_defects %>% as.numeric(),
#     quakers = quakers %>% as.numeric(),
#     color = color %>% as.factor(),
#     category_two_defects = category_two_defects %>% as.numeric(),
#     altitude_mean_meters = altitude_mean_meters %>% as.numeric()
#   )
# #Check IDs
# # head(all_ratings$id) 
# #Create training set
# train <- all_ratings %>% slice_sample(prop = .70)
# #Create test set
# test  <- all_ratings %>% anti_join(train, by = 'id')
```

```{r}
# fit_coffee_eda <-
#   glm(
#     formula = total_cup_points ~ 
#       # owner + 
#       country_of_origin +
#       # company + 
#       # region +
#       # producer +
#       number_of_bags +
#       # bag_weight +
#       harvest_year +
#       # variety +
#       processing_method +
#       category_one_defects +
#       quakers +
#       color +
#       category_two_defects +
#       altitude_mean_meters,
#     data = all_ratings,
#     family = "binomial"
#   )
# fit_tidy <- fit_coffee_eda %>% generics::tidy()
# rsquare(fit_coffee_eda, train)
# rsquare(fit_coffee_eda, test)
```

# Country-level
<!-- -------------------------------------------------- -->


```{r vis-usa}
df_usa %>%
  ggplot(aes(date)) +
  geom_point(aes(y = death, color = "Deaths")) +
  geom_point(aes(y = positive, color = "Cases")) +
  scale_y_log10()
```

```{r usa-deaths-v-increase}
df_usa %>%
  ggplot(aes(death, deathIncrease)) +
  geom_point() +
  geom_smooth() +
  scale_x_log10() +
  scale_y_log10()
```

# State-level
<!-- -------------------------------------------------- -->

### Timeline: Cases

```{r timeline-cases}
df_states_historical %>%
  # mutate(date = ymd(date)) %>%
  group_by(state_abbreviation) %>%
  mutate(max_positive = max(positive)) %>%
  ungroup() %>%
  filter(
    ## dense_rank(-max_positive) <= 10,
    ## state %in% c("CA", "NY", "WA", "MA", "HI")
    state_abbreviation %in% c("TX", "FL", "GA", "SC", "NC", "NY", "MA")
  ) %>%
  ggplot(aes(
    x = date,
    y = positive,
    color = fct_reorder2(state_abbreviation, date, positive)
    ## y = death,
    ## color = fct_reorder2(state, date, death)
  )) +
  geom_line() +
  ## scale_x_log10() +
  scale_y_log10(labels = scales::label_scientific()) +
  scale_color_discrete(name = "State") +
  theme_common()
```

### Timeline: Deaths

```{r timeline-cases}
df_states_historical %>%
  # mutate(date = ymd(date)) %>%state_abbreviation
  group_by(state_abbreviation) %>%
  mutate(max_positive = max(positive)) %>%
  ungroup() %>%
  filter(
    ## dense_rank(-max_positive) <= 10,
    state_abbreviation %in% c("CA", "NY", "WA", "MA")
  ) %>%
  ggplot(aes(
    x = date,
    y = death,
    color = fct_reorder2(state_abbreviation, date, death)
  )) +
  geom_line(size = 1) +
  scale_y_log10() +
  scale_color_discrete(name = "State") +
  theme_common()
```

### New vs Total plots

```{r vis-cases}
df_states_historical %>%
  group_by(state_abbreviation) %>%
  mutate(max_positive = max(positive)) %>%
  ungroup() %>%
  filter(
    positiveIncrease > 0,
    ## dense_rank(-max_positive) <= 10
    state_abbreviation %in% c("CA", "NY", "WA", "MA")
  ) %>%
  ggplot(aes(
    positive,
    positiveIncrease,
    color = state_abbreviation
  )) +
  geom_smooth(se = FALSE, size = 2) +
  ## geom_line() +
  ## geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme(legend.position = "bottom")
```

```{r vis-deaths}
df_states_historical %>%
  group_by(state_abbreviation) %>%
  mutate(max_positive = max(positive)) %>%
  ungroup() %>%
  filter(
    positiveIncrease > 0,
    ## dense_rank(-max_positive) <= 10
    state_abbreviation %in% c("CA", "NY", "WA", "MA")
  ) %>%
  ggplot(aes(
    death,
    deathIncrease,
    color = state_abbreviation
  )) +
  geom_smooth(se = FALSE, size = 2) +
  ## geom_line() +
  ## geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme(legend.position = "bottom")
```

```{r vis-tests}
df_states_historical %>%
  group_by(state_abbreviation) %>%
  mutate(max_test = max(totalTestResults)) %>%
  ungroup() %>%
  filter(
    totalTestResults > 0,
    ## dense_rank(-max_test) <= 5
    str_detect(state_abbreviation, "HI")
  ) %>%
  ggplot(aes(
    totalTestResults,
    totalTestResultsIncrease,
    color = state_abbreviation
  )) +
  geom_smooth(se = FALSE, size = 2) +
  geom_line() +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme_common()+
  theme(legend.position = "bottom")
```


```{r vis-normalized}
df_states_historical %>%
  group_by(state_abbreviation) %>%
  mutate(max_positive = max(positive)) %>%
  ungroup() %>%
  filter(
    positiveIncrease > 0,
    dense_rank(-max_positive) <= 8
  ) %>%
  ggplot(aes(
    positive / totalTestResults,
    positiveIncrease / totalTestResults,
    color = state_abbreviation
  )) +
  geom_smooth(se = FALSE, size = 2) +
  geom_line() +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme(legend.position = "bottom")
```

```{r}
df_states_historical %>%
  filter(state == "New York") %>%
  mutate(
    positivity_rate = (positiveIncrease/totalTestResultsIncrease),
    projected_cases = population * positivity_rate
  ) %>%
  ggplot() +
  geom_point(aes(x=date, y=positiveIncrease, color="positive cases increase"))
  # geom_point(aes(x=date, y=projected_cases, color="population * positivity rate"))
```


```{r}
df_states_historical %>%
  filter(state == "New York") %>%
  mutate(
    positivity_rate = (positiveIncrease/totalTestResultsIncrease),
    projected_cases = population * positivity_rate
  ) %>%
  ggplot() +
  geom_point(aes(x=date, y=positiveIncrease, color="positiveIncrease")) +
  geom_point(aes(x=date, y=projected_cases, color="population * positivity rate")) +
  geom_line(aes(x=date, y=population, color="NY Total Population"))
```

```{r}
df_states_historical %>%
  filter(state == "New York") %>%
  mutate(
    positivity_rate = (positiveIncrease/totalTestResultsIncrease),
    projected_cases = population * positivity_rate
  ) %>%
  ggplot() +
  geom_point(aes(x=date, y=positivity_rate, color="positivity rate"))
```

```{r}
df_states_racial_comb %>%
  filter(state == "California") %>%
  left_join(df_states_historical) %>%
  ggplot() +
  geom_line(aes(x=date, y=cases/positive, color=race))
```

```{r}
df_states_racial_comb %>%
  filter(state == "California") %>%
  left_join(df_states_historical) %>%
  ggplot() +
  geom_line(aes(x=date, y=cases_per_100k, color=race))
```


```{r}
foo <- df_states_racial_comb %>%
  filter(!is.na(date)) %>%
  arrange(date) %>%
  group_by(race, state) %>%
  mutate(
    rolling7dayavg_cases = mean_run(x = cases, k = 8, idx = date)
  ) %>%
  relocate(
    rolling7dayavg_cases,
    .after = cases
  ) %>%
  filter(state=="California",race=="White")

foo %>%
  ggplot() +
  geom_point(aes(x=date,y=cases,color="cases")) +
  geom_point(aes(x=date,y=rolling7dayavg_cases, color="rolling 7 day"))

```

```{r}
cases_model <- glm(
    formula = cases_per_100k ~ date + race + race_estimate,
    data = df_states_racial_comb %>%
      mutate(
        race = race %>% as.factor(),
        race = fct_relevel(race, "White"),
        cases_per_100k = cases_per_100k/max(cases_per_100k, na.rm = TRUE),
        race_estimate = race_estimate/max(race_estimate, na.rm = TRUE)
      ) %>%
      filter(
        !is.na(cases_per_100k),
      ),
    family = "binomial"
  )
cases_model %>% generics::tidy()
```




```{r}
df_states_racial_comb %>%
  filter(!is.na(tests_per_100k)) %>%
  filter(tests_per_100k != 0) %>%
  filter(race != "Other") %>%
  filter(race_estimate > 10000) %>%
  ggplot() +
  geom_line(aes(x=date, y=tests_per_100k, color=race)) +
  facet_wrap(~ state, scales = "free_y")
```

```{r}
df_states_racial_comb %>%
  filter(!is.na(tests_per_100k)) %>%
  filter(tests_per_100k != 0) %>%
  filter(race_estimate > 10000) %>%
  group_by(race, state) %>%
  arrange(date) %>%
  mutate(
    delta_tests_per_100k = tests_per_100k - lag(tests_per_100k)
  ) %>%
  # filter(race != "Other") %>%
  # filter(state == "Rhode Island") %>%
  filter(delta_tests_per_100k > 0) %>%
  filter(state == "Illinois") %>%
  ggplot() +
  geom_line(aes(x=date, y=delta_tests_per_100k, color=race)) +
  facet_wrap(~ state, scales = "free_y")
```



```{r}
df_states_racial_comb %>%
  filter(!is.na(tests_per_100k)) %>%
  filter(tests_per_100k != 0) %>%
  filter(race != "Other") %>%
  filter(race_estimate > 10000) %>%
  ggplot() +
  geom_boxplot(aes(x=race, y=tests_per_100k, color=race)) +
  facet_wrap(~ state, scales = "free_y")
```


```{r}
df_states_racial_comb %>%
  filter(!is.na(tests)) %>% 
  filter(tests > 100) %>%
  group_by(date, race) %>% 
  summarise(
    # deaths_per_cases = sum(deaths)/sum(cases),
    # hosp_per_cases = sum(hosp, na.rm = "TRUE")/sum(cases,  na.rm = "TRUE"),
    # deaths_per_hosp = sum(deaths,  na.rm = "TRUE")/sum(hosp,  na.rm = "TRUE"),
    tests = sum(tests),
    race_estimate = sum(race_estimate),
    .groups = "keep"
  ) %>% 
  mutate(
    tests_per_100k = tests/race_estimate
  ) %>%
   # filter(deaths_per_cases < .25) %>% 
ggplot(aes(x = date, y = tests_per_100k, color = race)) +
  geom_point(aes(shape = race), size = 1) +
  geom_line()
```
