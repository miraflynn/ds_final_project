---
title: "R Notebook"
output: github_document
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r setup}
library(tidyverse)
library(runner)
source("cleaning.R")
set.seed(42)
```

```{r}
df_states_racial_non_pivot
```





```{r}
df_states_racial_non_pivot %>%
  group_by(Date)%>%
  summarise(Cases_Total = sum(Cases_Total, na.rm = TRUE), Cases_Unknown = sum(Cases_Unknown, na.rm = TRUE)) %>%
  mutate(case_rpt = (Cases_Total-Cases_Unknown)/Cases_Total) %>%
  select(Date, case_rpt) %>%
  ggplot() +
  geom_line(aes(Date, case_rpt))
```


```{r tests}
df_states_racial_non_pivot %>%
  group_by(Date)%>%
  summarise(
    Tests_Total = sum(Tests_Total, na.rm = TRUE), 
    Tests_Unknown = sum(Tests_Unknown, na.rm = TRUE),
    Deaths_Total = sum(Deaths_Total, na.rm = TRUE), 
    Deaths_Unknown = sum(Deaths_Unknown, na.rm = TRUE)
    ) %>%
  mutate(test_rpt = (Tests_Total-Tests_Unknown)/Tests_Total) %>%
  select(Date, test_rpt) %>%
  ggplot() +
  geom_line(aes(Date, test_rpt))
```
```{r}
df_states_racial_non_pivot %>%
  group_by(Date)%>%
  summarise(
    Tests_Total = sum(Tests_Total, na.rm = TRUE), 
    Tests_Unknown = sum(Tests_Unknown, na.rm = TRUE),
    Deaths_Total = sum(Deaths_Total, na.rm = TRUE), 
    Deaths_Unknown = sum(Deaths_Unknown, na.rm = TRUE)
    ) %>%
  mutate(death_rpt = (Deaths_Total-Deaths_Unknown)/Deaths_Total) %>%
  select(Date, death_rpt) %>%
  ggplot() +
  geom_line(aes(Date, death_rpt))
```

```{r}
df_states_racial_non_pivot %>%
  mutate(
    case_rpt = (Cases_Total-Cases_Unknown)/Cases_Total,
    test_rpt = (Tests_Total-Tests_Unknown)/Tests_Total) %>%
  select(Date, State, case_rpt, test_rpt) %>%
  # group_by(Date)%>%
  # summarise(Cases_Total = sum(Cases_Total, na.rm = TRUE), Cases_Unknown = sum(Cases_Unknown, na.rm = TRUE)) %>%
  filter(test_rpt != 0) %>%
  filter(State != "RI" & State != "NV") %>%
  ggplot()+
  geom_line(aes(Date, test_rpt, color = State))
```



##### Death Rate Rolling Average ###

```{r}
df_states_racial_comb %>%
  filter(!is.na(deaths)) %>%
  filter(!is.na(cases)) %>%
  filter(!is.na(date)) %>%
  arrange(date) %>%
  group_by(race, state) %>%
  mutate(
    delta_cases_inst = cases - lag(cases),
    delta_deaths_inst = deaths - lag(deaths),
    rolling7dayavg_cases = mean_run(x = delta_cases_inst, k = 60, idx = date),
    rolling7dayavg_deaths = mean_run(x = delta_deaths_inst, k = 60, idx = date)
  ) %>%
  select(date, state, race, rolling7dayavg_cases, rolling7dayavg_deaths) %>%
  filter(!is.na(rolling7dayavg_cases) |
         !is.na(rolling7dayavg_deaths) 
           )%>%
  # filter(state == "Massachusetts") %>%
  group_by(date, race) %>%
  summarise(rolling7dayavg_cases = sum(rolling7dayavg_cases), rolling7dayavg_deaths = sum(rolling7dayavg_deaths))%>%
  mutate(death_rate = rolling7dayavg_deaths/rolling7dayavg_cases) %>%
  filter(death_rate <= .3 & death_rate >= -0.3) %>%
  ggplot() +
  geom_line(aes(x = date, y = death_rate, color = race))#+
 # geom_line(aes(x = date, y = rolling7dayavg_cases, color = race))
```







#### Death Rate By Time in Pandemic ###






































```{r}
df_states_racial_comb

```


```{r}
df_states_racial_comb %>%
  filter(date == "2020-12-06") %>%
  filter(deaths <= 3000) %>%
  ggplot(aes(deaths, race_estimate, color = race)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE)
?geom_smooth
```
```{r}
df_states_racial_comb %>%
  filter(date == "2020-12-06") %>%
  filter(cases_per_100k <= 10000000) %>%
  mutate(race = fct_reorder(race, cases_per_100k)) %>%
  ggplot() +
  geom_boxplot((aes(race, cases_per_100k)))
```
```{r}
df_states_racial_comb %>%
  group_by(date, race) %>%
  summarise(total_tests = sum(tests, na.rm = TRUE), race_estimate = sum(race_estimate)) %>%
  mutate(tests_per_100k = total_tests/race_estimate*100000) %>%
  ggplot() +
  geom_line(aes(date, tests_per_100k, color = race))
```

```{r}
df_states_racial_comb %>%
  group_by(date, race) %>%
  summarise(total_cases = sum(cases, na.rm = TRUE), race_estimate = sum(race_estimate)) %>%
  mutate(cases100k = total_cases/race_estimate*100000) %>%
  ggplot() +
  geom_line(aes(date, cases100k, color = race))
```


```{r}
df_states_racial_comb %>%
  filter(cases_per_100k <= 50000) %>%
  mutate(race = fct_reorder(race, cases_per_100k)) %>%
  ggplot() +
  geom_boxplot((aes(race, cases_per_100k)))
```

```{r}
df_usa %>%
  ggplot() +
  geom_line(aes(date, positiveIncrease))+
  geom_line(aes(date, totalTestResultsIncrease))
```
```{r}
df_states_historical %>%
  ggplot()+
  geom_bar(aes(dataQualityGrade))
```


```{r}
df_states_racial_comb %>%
  group_by(date,category) %>%
  summarise()
  ggplot() +
  geo
```